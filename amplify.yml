version: 1
backend:
  phases:
    build:
      commands:
        - echo "No backend build required"
frontend:
  phases:
    preBuild:
      commands:
        - ls -la
        - pwd
        - npm install
    build:
      commands:
        # Amplifyの環境変数を.env.productionファイルに書き出す
        - echo "# Generated by Amplify build" > .env.production
        - echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env.production
        - echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY" >> .env.production
        - echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY" >> .env.production
        # デバッグ用：環境変数が正しく設定されているか確認
        - echo "=== Environment Variables Check ==="
        - cat .env.production
        - echo "=== End Check ==="
        # ビルド実行
        - npm run build
        # 静的エクスポート用に環境変数ファイルをoutディレクトリに配置
        - cp .env.production out/.env.production || true
  artifacts:
    baseDirectory: out
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
